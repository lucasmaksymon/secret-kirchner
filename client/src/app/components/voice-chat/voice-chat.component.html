<div class="voice-chat-bubble" [class.minimized]="isMinimized" [class.pinned]="isPinned" [class.embedded]="embedded">
  <!-- BotÃ³n flotante cuando estÃ¡ minimizado -->
  <button 
    *ngIf="isMinimized" 
    class="voice-toggle-btn"
    [class.connected]="isConnected"
    (click)="toggleMinimize()"
    [attr.aria-label]="'Abrir chat de voz'"
  >
    {{ isConnected ? 'ğŸ¤' : 'ğŸ§' }}
    <span class="connected-indicator" *ngIf="isConnected"></span>
  </button>

  <!-- Contenedor del chat de voz -->
  <div class="voice-chat-container card" *ngIf="!isMinimized">
    <div class="voice-header">
      <h4>ğŸ¤ Chat de Voz</h4>
      <div class="voice-controls-header" *ngIf="!embedded">
        <button 
          class="voice-control-btn"
          (click)="togglePin()"
          [attr.aria-label]="isPinned ? 'Desfijar chat de voz' : 'Fijar chat de voz'"
          [title]="isPinned ? 'Desfijar' : 'Fijar'"
        >
          {{ isPinned ? 'ğŸ“Œ' : 'ğŸ“' }}
        </button>
        <button 
          class="voice-control-btn"
          (click)="toggleMinimize()"
          [attr.aria-label]="'Minimizar chat de voz'"
          title="Minimizar"
        >
          â–
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="voice-error">
      âš ï¸ {{ errorMessage }}
    </div>

    <!-- Voice Controls -->
    <div class="voice-controls">
      <button 
        class="btn-voice"
        [class.connected]="isConnected"
        [class.connecting]="isConnecting"
        [disabled]="isConnecting"
        (click)="toggleVoiceChat()"
        [title]="isConnected ? 'Salir del chat de voz' : 'Unirse al chat de voz'"
      >
        <span class="voice-icon">
          {{ isConnecting ? 'â³' : isConnected ? 'ğŸšª' : 'ğŸ§' }}
        </span>
        <span class="voice-label">
          {{ isConnecting ? 'Conectando...' : isConnected ? 'Salir del Chat' : 'Entrar al Chat' }}
        </span>
      </button>

      <!-- Audio Controls (only when connected) -->
      <div *ngIf="isConnected" class="audio-controls">
        <button 
          class="btn-control"
          [class.active]="!isMuted"
          [class.muted]="isMuted"
          (click)="toggleMute()"
          [title]="isMuted ? 'Activar micrÃ³fono' : 'Silenciar micrÃ³fono'"
        >
          <span class="control-icon">{{ isMuted ? 'ğŸ”‡' : 'ğŸ¤' }}</span>
        </button>

        <button 
          class="btn-control"
          [class.active]="!isDeafened"
          [class.deafened]="isDeafened"
          (click)="toggleDeafen()"
          [title]="isDeafened ? 'Activar audio' : 'Desactivar audio'"
        >
          <span class="control-icon">{{ isDeafened ? 'ğŸ”‡' : 'ğŸ”Š' }}</span>
        </button>
      </div>
    </div>

    <!-- Voice Users List (when connected) -->
    <div *ngIf="isConnected && voiceUsers.size > 0" class="voice-users-list">
      <div class="voice-users-header">
        <span>ğŸ‘¥ En el chat ({{ voiceUsers.size }})</span>
      </div>
      <div class="voice-users-items">
        <div 
          *ngFor="let user of getVoiceUsersArray()"
          class="voice-user-item"
          [class.speaking]="user.isSpeaking"
          [class.muted]="user.isMuted"
        >
          <span class="user-indicator">
            <span class="speaking-wave" *ngIf="user.isSpeaking && !user.isMuted"></span>
            <span class="muted-icon" *ngIf="user.isMuted">ğŸ”‡</span>
            <span class="idle-icon" *ngIf="!user.isSpeaking && !user.isMuted">ğŸ”Š</span>
          </span>
          <span class="user-name">{{ user.playerName }}</span>
        </div>
      </div>
    </div>

    <!-- Speaking Indicator (compact) -->
    <div *ngIf="isConnected && getSpeakingUsers().length > 0" class="speaking-indicator">
      ğŸ—£ï¸ <strong>{{ getSpeakingUsers()[0].playerName }}</strong>
      <span *ngIf="getSpeakingUsers().length > 1">
        +{{ getSpeakingUsers().length - 1 }} mÃ¡s
      </span>
    </div>
  </div>
</div>
