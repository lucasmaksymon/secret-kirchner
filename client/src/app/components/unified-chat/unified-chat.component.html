<div class="unified-chat-bubble" 
     [class.minimized]="isMinimized" 
     [class.embedded]="embedded">
  
  <!-- BotÃ³n flotante cuando estÃ¡ minimizado -->
  <button 
    *ngIf="isMinimized && !embedded" 
    class="unified-toggle-btn"
    [class.has-unread]="unreadCount > 0"
    [class.voice-connected]="isConnected"
    (click)="toggleMinimize()"
    [attr.aria-label]="'Abrir chat'"
  >
    <span *ngIf="activeTab === 'text'">ğŸ’¬</span>
    <span *ngIf="activeTab === 'voice'">{{ isConnected ? 'ğŸ¤' : 'ğŸ§' }}</span>
    <span class="unread-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
    <span class="connected-indicator" *ngIf="isConnected && activeTab === 'voice'"></span>
  </button>

  <!-- Contenedor principal -->
  <div class="unified-chat-container card" *ngIf="!isMinimized || embedded">
    <!-- Header con tabs -->
    <div class="unified-header">
      <div class="tabs">
        <button 
          class="tab-btn"
          [class.active]="activeTab === 'text'"
          (click)="setTab('text')"
        >
          ğŸ’¬ Texto
          <span class="unread-indicator" *ngIf="unreadCount > 0 && activeTab !== 'text'">{{ unreadCount }}</span>
        </button>
        <button 
          class="tab-btn"
          [class.active]="activeTab === 'voice'"
          (click)="setTab('voice')"
        >
          ğŸ¤ Voz
          <span class="connected-dot" *ngIf="isConnected && activeTab !== 'voice'"></span>
        </button>
      </div>
      
      <div class="unified-controls" *ngIf="!embedded">
        <button 
          class="control-btn"
          (click)="toggleMinimize()"
          [attr.aria-label]="'Minimizar chat'"
          title="Minimizar"
        >
          â–
        </button>
      </div>
    </div>

    <!-- Contenido del tab de texto -->
    <div class="tab-content" *ngIf="activeTab === 'text'">
      <div class="chat-messages" #chatMessagesContainer>
        <div 
          *ngFor="let message of chatMessages$ | async"
          class="chat-message"
        >
          <span class="message-author">{{ message.playerName }}:</span>
          <span class="message-text">{{ message.message }}</span>
        </div>
      </div>

      <div class="chat-input">
        <input 
          type="text" 
          [(ngModel)]="newMessage"
          (keypress)="onKeyPress($event)"
          placeholder="EscribÃ­ un mensaje..."
          maxlength="200"
        />
        <button 
          class="btn btn-primary"
          (click)="sendMessage()"
          [disabled]="!newMessage.trim()"
        >
          Enviar
        </button>
      </div>
    </div>

    <!-- Contenido del tab de voz -->
    <div class="tab-content voice-content" *ngIf="activeTab === 'voice'">
      <!-- Error Message -->
      <div *ngIf="errorMessage" class="voice-error">
        âš ï¸ {{ errorMessage }}
      </div>

      <!-- Voice Controls -->
      <div class="voice-controls">
        <button 
          class="btn-voice"
          [class.connected]="isConnected"
          [class.connecting]="isConnecting"
          [disabled]="isConnecting"
          (click)="toggleVoiceChat()"
          [title]="isConnected ? 'Salir del chat de voz' : 'Unirse al chat de voz'"
        >
          <span class="voice-icon">
            {{ isConnecting ? 'â³' : isConnected ? 'ğŸšª' : 'ğŸ§' }}
          </span>
          <span class="voice-label">
            {{ isConnecting ? 'Conectando...' : isConnected ? 'Salir del Chat' : 'Entrar al Chat' }}
          </span>
        </button>

        <!-- Audio Controls (only when connected) -->
        <div *ngIf="isConnected" class="audio-controls">
          <button 
            class="btn-control"
            [class.active]="!isMuted"
            [class.muted]="isMuted"
            (click)="toggleMute()"
            [title]="isMuted ? 'Activar micrÃ³fono' : 'Silenciar micrÃ³fono'"
          >
            <span class="control-icon">{{ isMuted ? 'ğŸ”‡' : 'ğŸ¤' }}</span>
          </button>

          <button 
            class="btn-control"
            [class.active]="!isDeafened"
            [class.deafened]="isDeafened"
            (click)="toggleDeafen()"
            [title]="isDeafened ? 'Activar audio' : 'Desactivar audio'"
          >
            <span class="control-icon">{{ isDeafened ? 'ğŸ”‡' : 'ğŸ”Š' }}</span>
          </button>
        </div>
      </div>

      <!-- Voice Users List (when connected) -->
      <div *ngIf="isConnected && voiceUsers.size > 0" class="voice-users-list">
        <div class="voice-users-header">
          <span>ğŸ‘¥ En el chat ({{ voiceUsers.size }})</span>
        </div>
        <div class="voice-users-items">
          <div 
            *ngFor="let user of getVoiceUsersArray()"
            class="voice-user-item"
            [class.speaking]="user.isSpeaking"
            [class.muted]="user.isMuted"
          >
            <span class="user-indicator">
              <span class="speaking-wave" *ngIf="user.isSpeaking && !user.isMuted"></span>
              <span class="muted-icon" *ngIf="user.isMuted">ğŸ”‡</span>
              <span class="idle-icon" *ngIf="!user.isSpeaking && !user.isMuted">ğŸ”Š</span>
            </span>
            <span class="user-name">{{ user.playerName }}</span>
          </div>
        </div>
      </div>

      <!-- Speaking Indicator (compact) -->
      <div *ngIf="isConnected && getSpeakingUsers().length > 0" class="speaking-indicator">
        ğŸ—£ï¸ <strong>{{ getSpeakingUsers()[0].playerName }}</strong>
        <span *ngIf="getSpeakingUsers().length > 1">
          +{{ getSpeakingUsers().length - 1 }} mÃ¡s
        </span>
      </div>
    </div>
  </div>
</div>

